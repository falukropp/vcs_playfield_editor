<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>VCS Editor</title>
        <link rel="stylesheet" href="style.css">
        <script type="module">
            import { Playfield, PlayfieldMode } from './playfield.js';
            import { DrawMode, Editor } from './editor.js';
            import { VCSData } from './vcs_data.js';
            import { GameData } from './gamedata.js';
            import { EVENTS, CustomEventHandler } from './custom_event_handler.js';

            const customEventHandler = new CustomEventHandler(document);

            const gameData = new GameData();
            const vcsRows = 192;
            const scanLinesPerVcsRow = 12; // Should be maybe modifiable
            const vcsPlayfieldRows = vcsRows / scanLinesPerVcsRow;

            const idsAndModes = [
                ['drawModeScribble', DrawMode.SCRIBBLE],
                ['drawModeLine', DrawMode.LINE],
                ['drawModeFilledRect', DrawMode.FILLED_RECT],
                ['drawModeRectangle', DrawMode.RECT],
                ['drawModeFilledEllipse', DrawMode.FILLED_ELLIPSE],
                ['drawModeEllipse', DrawMode.ELLIPSE],
            ];

            document.addEventListener('DOMContentLoaded', function () {
                const playfield = new Playfield(vcsPlayfieldRows);

                const canvas = document.getElementById('playfield');
                canvas.oncontextmenu = () => false;

                const editor = new Editor(document, customEventHandler, canvas, playfield);

                gameData.addPlayfield(playfield)

                const vcsData = new VCSData(document.getElementById('vcs_data'), gameData);

                document.getElementById('playfieldNormalMode').addEventListener('click', () => editor.setEditorMode(PlayfieldMode.NORMAL));
                document.getElementById('playfieldMirrorMode').addEventListener('click', () => editor.setEditorMode(PlayfieldMode.REFLECTED));
                document.getElementById('playfieldUndo').addEventListener('click', () => editor.undo());
                document.getElementById('playfieldRedo').addEventListener('click', () => editor.redo());

                document.getElementById('edit_mode_pf0').addEventListener('change', (e) => editor.setRegisterMode(0, e.target.value));
                document.getElementById('edit_mode_pf1').addEventListener('change', (e) => editor.setRegisterMode(1, e.target.value));
                document.getElementById('edit_mode_pf2').addEventListener('change', (e) => editor.setRegisterMode(2, e.target.value));

                document.getElementById('updateData').addEventListener('click', () => vcsData.updateFromGameData());
                document.getElementById('include_pf0').addEventListener('change', (e) => vcsData.setIncludeRegister(0, e.target.checked));
                document.getElementById('include_pf1').addEventListener('change', (e) => vcsData.setIncludeRegister(1, e.target.checked));
                document.getElementById('include_pf2').addEventListener('change', (e) => vcsData.setIncludeRegister(2, e.target.checked));

                idsAndModes.forEach(([id, mode]) => document.getElementById(id).addEventListener('click', () => editor.setDrawMode(mode)));

                editor.updateCanvas();
            });

            customEventHandler.addEventListener(EVENTS.EDITOR_STATE_CHANGED, (e) => {
                [...document.getElementsByClassName('playfieldMode')].forEach((e) => e.classList.remove('selected'));
                document
                    .getElementById(e.detail.playfieldMode === PlayfieldMode.NORMAL ? 'playfieldNormalMode' : 'playfieldMirrorMode')
                    .classList.add('selected');

                [...document.getElementsByClassName('drawMode')].forEach((e) => e.classList.remove('selected'));
                const selectedDrawModeId = idsAndModes.find(([id, mode]) => mode === e.detail.drawMode)?.[0];
                document.getElementById(selectedDrawModeId)?.classList.add('selected');

                document.getElementById('edit_mode_pf0').value = e.detail.registerModes[0];
                document.getElementById('edit_mode_pf1').value = e.detail.registerModes[1];
                document.getElementById('edit_mode_pf2').value = e.detail.registerModes[2];
            });
        </script>
    </head>

    <body>
        <div class="grid-container">
            <div class="Editor">
                <!--
                  Each vcs_pixel is scanlines per pixels * 5 pixel high, and 32 pixels wide
                  960px;  /* 192 * 5  (5 so that height * 4/3 is divible by 40)*/
                  1280px;  /*  960 * 4/3 */
                -->
                <canvas id="playfield" width="1280" height="960"> Your browser does not support HTML5 Canvas. </canvas>
            </div>
            <div class="Commands">
                <h1>Simple VCS Playfield editor</h1>
                <div class="toolbar">
                    <button class="playfieldMode" id="playfieldNormalMode">Normal</button>
                    <button class="playfieldMode" id="playfieldMirrorMode">Mirror</button>
                    <button id="playfieldUndo">Undo</button>
                    <button id="playfieldRedo">Redo</button>
                    <label
                        >PF0
                        <select id="edit_mode_pf0">
                            <option selected value="DRAW">draw</option>
                            <option value="FILL">fill</option>
                            <option value="CLEAR">clear</option>
                        </select>
                    </label>
                    <label
                        >PF1
                        <select id="edit_mode_pf1">
                            <option selected value="DRAW">draw</option>
                            <option value="FILL">fill</option>
                            <option value="CLEAR">clear</option>
                        </select>
                    </label>
                    <label
                        >PF2
                        <select id="edit_mode_pf2">
                            <option selected value="DRAW">draw</option>
                            <option value="FILL">fill</option>
                            <option value="CLEAR">clear</option>
                        </select>
                    </label>
                </div>
                <div class="toolbar">
                    <button class="drawMode" id="drawModeScribble">Scribble</button>
                    <button class="drawMode" id="drawModeLine">Line</button>
                    <button class="drawMode" id="drawModeFilledRect">Filled rect</button>
                    <button class="drawMode" id="drawModeRectangle">Rectangle</button>
                    <button class="drawMode" id="drawModeFilledEllipse">Filled ellipse</button>
                    <button class="drawMode" id="drawModeEllipse">Ellipse</button>
                </div>
            </div>
            <div class="Data">
                <div class="toolbar">
                    <button id="updateData">Update data</button>
                    <label>PF0<input type="checkbox" id="include_pf0" name="include_pf0" value="include" checked="checked" /></label>
                    <label>PF1<input type="checkbox" id="include_pf1" name="include_pf1" value="include" checked="checked" /></label>
                    <label>PF2<input type="checkbox" id="include_pf2" name="include_pf2" value="include" checked="checked" /></label>
                    <div>
                        <textarea id="vcs_data" readonly cols="40" rows="50">...</textarea>
                    </div>
                </div>
            </div>
            <div class="Palette">
                <!-- 40 * 32 is not quit 4:3 aspect ration, but should be close enough. -->
                <canvas  width="40" height="32"></canvas>
                <canvas  width="40" height="32"></canvas>
            </div>
            <div class="Map">Map</div>
        </div>
    </body>
</html>
